---
title: "Securisation SSH : Utilisation de clefs a la place des password."
date: 2020-11-20T13:19:36+01:00
author: Guillaume Moulard
url: /SSH-Clef
draft: false
type: post
tags:
  - SSH
  - Securite
  - certificat
  - sshd
categories:
  - tutoriel
---

# Pourquoi des clefs ssh et pas des password?

Il y a deux raison d'utiliser des clefs et pas des password pour le SSH l'une est bonne et l'autre mauvaise.
La mauvaise raison est gérer, memorisé et taper des password n'est pas le but de la vie. Et qui plus est c'est penible. 
La bonne est que les passowrds sur internet sa ne resiste pas au brute force attaque. Un password de 8 caracteres meme complexe est bien moins secure qu'une clef des 4096 bits. 

Dans le cloud quand vous laissez un serveur SSH accessible, en quelques minutes c'est the finalle bot attaque !!!

Moi j'ai bien dire que la clef privé est une clef, et que la clef public est un serure. 
La clef privé permet d'ouvrir les portes securisé avec la clef public. Evidement si vous pouvez partagé la clef public, il faut précicieusement garder secrete la clef privé. 
La passphrase, est le code secret nécessaire a l'utilisation de la clef privé. 

## Comment empecher les password dans SSH 
mettre a no le parmettre PasswordAuthentication du fichier /etc/ssh/sshd_config
```bash
pi@pi3:~/.ssh $ grep PasswordAuthentication /etc/ssh/sshd_config
PasswordAuthentication no

```

Restart server sshd
```bash
root@pi3:~# systemctl restart sshd
```

# Comment faire une clef

Avec puttygen sous windows c'est simplicime, il faut juste pas oublier de bouger la souris sous la barre verte pour generer de l'aleatoire. 

avec openssh c'est encore plus simple 
```bash
pi@pi3:~/.ssh $ ssh-keygen -t rsa -b 4096
Generating public/private rsa key pair.
Enter file in which to save the key (/home/pi/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/pi/.ssh/id_rsa.
Your public key has been saved in /home/pi/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:WJfG2b35KlyIkbY+jo+H3dyMKrtJiSoC0JRyIe9ptlw pi@pi3
The key's randomart image is:
+---[RSA 4096]----+
|. .o             |
|.o+      . + .   |
| =.     . *.. .  |
|....   o o+    o |
|. = E . S. + .o  |
|.+ o   . .o . .. |
|. o   . o+ + =  .|
|. .  . .o+= * o. |
| . ..   *B+o ..  |
+----[SHA256]-----+
```

```bash
pi@pi3:~/.ssh $ cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC0g4DwZskmd8kcYyb7dvljI8B0NxhOHjIjrfzh+GmZsQvF2L+08QBComrwfMp+Z9jE1YmAf4RBoFUHahZYpJiS0t0VgUQqCO/WKhygQwP/f7w+29H1WnJARkUy9eKCjzD13gdSzbzZMrucps6bmF+mnHGJ5G2kZHMWCMk+tglfz6vgnN5thTFkP3lFCZo1njT+dzsFxPAHNZxfEDsRyUxBCd2ItC4iQcEIJAvO2vVFVID3TW/BkAzXpFiyvIsScqEi4H4mochmL05nUscjrLj+1Wi8Y2Z99VXTAMIF7fMz/spDL46GWnn5FSXzvY/qc1vj5OXNpNeAKELySszw60l1zRgaV9LWKJ5rIYNbcWqG7Q6O7FXaXEMQ0Jre/j2upXEbM3qrlACXojUZx6WO1eKTnRisZcZebrVtcFv2IkzKMV18wzni61PSUqD9a/i3cxnNz+80oYI6ARlqd4vh1bZIJRnN4+SqUzSM5w7Rw8mdxhSzbU9IDEZTshA84+j/CDvbIKtnpXmvlyUbvFLS39LGAOC0NtgZhb7JQ+pwCPJ69lJqiBwelOi0uRUGQ86j+XSf0GNbUC/HGL08VJWT1wum9CNaEqVliZ+VKw+zYyVMa64Hf6PeF54FOH+/jLUSQeFGB7NrP0hKTznD6baLR9F3A4ose01JCX5kbXp91W6R7Q== pi@pi3

pi@pi3:~/.ssh $ cat id_rsa
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,91FE4EEA4EF377C38F0D56DC7BE40B3F

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
-----END RSA PRIVATE KEY-----
```
# Comment pousser sa clef sur un serveur

La clefs public doit être mise dans la liste des clefs du compte que l'on souhaite acceder 
Classiquement /home/<<user>>/.ssh/authorized_keys
rechercher dans le fichier /etc/ssh/sshd_config  la clef AuthorizedKeysFile par defaut a  %h/.ssh/authorized_keys

##Copie de la clefs sur un server

```bash
pi@pi3:~/.ssh $ ssh-copy-id pi@pi4b.home
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/pi/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed

/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
                (if you think this is a mistake, you may want to use -f option)

```

```bash
pi@pi3:~/.ssh $ ssh pi@pi4b.home -i id_rsa
Linux pi4b 4.19.75-v7l+ #1270 SMP Tue Sep 24 18:51:41 BST 2019 armv7l

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sat Mar  7 11:05:33 2020 from 192.168.1.29
pi@pi4b:~ $
```

##Copie de la clefs manuelement 
```bash
pi@pi3:~/.ssh $ cat id_rsa.pub >> /home/pi/.ssh/authorized_keys
```

attention au autorisation sur le fichier authorized_keys 
```bash
pi@pi3:~/.ssh $ ls -l /home/pi/.ssh/authorized_keys
-rw------- 1 pi pi 3505 mars   7 12:01 /home/pi/.ssh/authorized_keys
```


# Pourquoi les certificats SSL C'est mieux qu'une clefs SSH

Mettre en place des certificats pousse encore la securité un peut plus loins car il est alors possible de donnée des delais de validité de faire les liste de revocation et des restriction d'usage du SSH : clear,force-command=command, no-agent-forwarding, no-port-forwarding, no-pt, no-user-rc, no-x11-forwarding, permit-agent-forwarding, permit-port-forwarding, permit-pty, permit-user-rc, permit-x11-forwarding, source-address=address_list

# Comment faire mettre en oeuvre une CA sur le serveur SSHD 

## 1. creation de la CA Certificat Autority
```bash
root@pi3:~# ssh-keygen -t rsa -b 4096 -f /etc/ssh/ca
Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /etc/ssh/ca.
Your public key has been saved in /etc/ssh/ca.pub.
The key fingerprint is:
SHA256:Ax5NHQgoY8kpb3lNA/zElBFvJhQAt1G+EsJfMXyHPdo root@pi3
The key's randomart image is:
+---[RSA 4096]----+
| ..==O@*.=..     |
|..B.o=B*+ =      |
| +o+o=*o=+ .     |
|  +o.+oB. E      |
| . .o o S        |
|     .   .       |
|                 |
|                 |
|                 |
+----[SHA256]-----+
root@pi3:~# ls -l /etc/ssh/ca*
-rw------- 1 root root 3243 mars   7 12:33 /etc/ssh/ca
-rw-r--r-- 1 root root  734 mars   7 12:33 /etc/ssh/ca.pub
root@pi3:~#
```bash



## 2. setup des la CA dans les serveur SSH sshd

```bash
echo "TrustedUserCAKeys /etc/ssh/ca.pub" >> /etc/ssh/sshd_config
root@pi3:~# systemctl restart sshd
``` 

# Comment créer sa clefs et la signé par sa CA

comme precedement, pour créer sa clef, rien de plus simple: 
avec openssh c'est encore plus simple 
```bash
pi@pi3:~/.ssh $ ssh-keygen -t rsa -b 4096 -f /home/pi/.ssh/clef2
Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/pi/.ssh/clef2.
Your public key has been saved in /home/pi/.ssh/clef2.pub.
The key fingerprint is:
SHA256:AAcbm67DjpfcQOS9Ii8JS3H1ZPs9MsCmKA/jXACEeF0 pi@pi3
The key's randomart image is:
+---[RSA 4096]----+
|+. .+oE          |
|+ o .O o         |
|.+ .= * .        |
| ooo.  B         |
| .+ o.o S .      |
|o*o+..   + o     |
|=*X=      o .    |
|+==o.            |
|.o.              |
+----[SHA256]-----+
pi@pi3:~/.ssh $
```

et la signature par le CA :

```bash
pi@pi3:~/.ssh $ sudo ssh-keygen -s /etc/ssh/ca -n "Signaturede la clef" -I 1 -V +365d /home/pi/.ssh/clef2.pub
Signed user key /home/pi/.ssh/clef2-cert.pub: id "1" serial 0 for Signaturede la clef valid from 2020-03-07T12:49:00 to 2021-03-07T12:50:00
pi@pi3:~/.ssh $ sudo chown pi:pi /home/pi/.ssh/clef2-cert.pub
```

Ont a mainenant : un ficher /home/pi/.ssh/clef2-cert.pub qui est comme une clef public classique mais avec une duré de validité de 365 jour

```bash
pi@pi3:~/.ssh $ cat /home/pi/.ssh/clef2-cert.pub
ssh-rsa-cert-v01@openssh.com AAAAHHNzaC1yc2EtY2VydC12MDFAb3BlbnNzaC5jb20AAAAgQzzzhWBcQU08QMMiOO+XKu832ciknAw2CERpoDEhfdUAAAADAQABAAACAQDFREAoEwQG53su6IlJXuXvX10nPcwzgX/aHFY04DdZezlvXlKlU4iab0I7e6lB1JJ8wFu1WlEoXVWqPmncMkBgfYWCWb3fggqV8AQU/gfIuBuVAJycahCd5FclwRqrEP3vD5TvY/O2VqYfNybdMJXM3hAuiLbQsTRzapu6OtLeWITqSn9criMiBBnsUyY8BUZq0dP1o3fQYBMKkzII9+HiuKNBOgWZ2iWlvKboNE8RNgXKx6E4UXyokjV5Zts4Drtp5sy1xc0CK3zWu/iCaGtbvhUSPMDlVLnh+kPQAT/Yv5++8Oy+ac7bkg4gJ6uWtzwIEaaN08a/WRyOoZW7R0Kza6tm3Cr7Wsi5tGiTBAAOtGiWUR5S5Ipg+BDqRixTLduGeza8emm9qo+95MQL4AaBzMRt2mocV20VJ+EByDhzRfI6XK0lGRJRuhGtV5LY0R6GWruNsp2fFzw1xAg4g79ecYlvNMeWLzm3lgGGGDvaMop/N4TLRoERk66gSFevMHXHjZ9s9zxD20mPgsfZoYpEP01rusCpyqNCx99IEGmcp22wBEOcPYV92h8Al/9D+8v/U/yv5ilc5KFC2UtARoJZq0Hkw9h/npTVSeGrLrzFpWDM/uA2C2aF3mgtUI0DPawnMPPgl9pzQX4JEIjvTvcXxDHIdc1CI1oj+0xcBChTeQAAAAAAAAAAAAAAAQAAAAExAAAAFwAAABNTaWduYXR1cmVkZSBsYSBjbGVmAAAAAF5jiiwAAAAAYES96AAAAAAAAACCAAAAFXBlcm1pdC1YMTEtZm9yd2FyZGluZwAAAAAAAAAXcGVybWl0LWFnZW50LWZvcndhcmRpbmcAAAAAAAAAFnBlcm1pdC1wb3J0LWZvcndhcmRpbmcAAAAAAAAACnBlcm1pdC1wdHkAAAAAAAAADnBlcm1pdC11c2VyLXJjAAAAAAAAAAAAAAIXAAAAB3NzaC1yc2EAAAADAQABAAACAQC3QHWkbueW7y0CXF8c8gsxERkrfLdPfttdh9lDwhrQqmmqdb1gOdkCl7sweFD3CmKQA/lGV4j/7npRfkJiMtNHGhj5nBnqUVHYhwqq6/ju0TggcMnkLHNF6ivxvAj+2BtTyOejyR1/qlYDCDfUexwq+k1d+hPrEAFkv1C+PVmmN+ennO/AOcFr2F5oomcNWVrewxk4h3KQYHgLZhIyXzlH1bUGc+OVDzRR2n4Nx4R/rG4NVBtFIVZlUP6Nqewt3xdt66+KcDXtxa1O96GIksbMTqWpMAOgWEXggPwiXkLkezVEun7+E3ps1Gu5c3/xivrawild5x0AKnBPmRI7fY4I7nLR5EP3k0p9plr/Gai/A9q1pEf10T41nfeNOQnAVJSYo3ICx4St3oZ0gdyz0ORDXUpveXRSw+HpdjBCdX8zGKyrCopO/xNGwSPK72QefKexnYi/0BelnDgvfdKxlrixH6BCRsvALBI3RsuQ5xNZUxfHagyjeklEoF5qTiH2hM2kFftLezfqFbNDfK3r3KDD6u8brHSZwRzb2gPp447d1cUEKSDyxKscu4RpiXGoB8p2QKmHWad/gb0wBAc6KUvwBiUB6qRWL8JaRu/+5Rc7fBWsOv2r6dJ3tUgYEu3H+dUzwXFQXGrhjxYvZqg9KxfBjfbJ9Oq+1ZTePweVeDFHEwAAAg8AAAAHc3NoLXJzYQAAAgCGGBRLVLOylwymVqM9i4MJuaXXfGduT1s1P+KmiEJ20PZY2QT1ggbcCsbR3M9o1BjUDRiNzuzMfWlR+Vy2c0wJWPfFhb0E/DtUETFQMLfLGGNYGhdD4136kmKNB0tsB+UsLFCn7ZHBtDwVEzfpGj2/QfL5YnQ2JcgVNyv5NAwM2JfNkGusWcZRzky4UXa2ucDO8tvcaUaqlkKPKDbezQ1AAFMmZX6mu4Q5HUN4aZ0LR8kafSZeZ/XlJmngvoIhLglNpNgVoTpAwun011shsNi9TOmnloskJc0OfuxEWwbU//O+M6Q/vk0mc9K+lh9GzKZDOw+9gH+Ja+HJZj30+7dH2greTZn4TKa7lg6/a8RaYEMsOxY0T9TQ742rXEwwqShoCtHJ1Bpxt105pZZkqzpun0MJvIPuE+/q5LHBDkJgybZ+ZWIYgF+/0rol8k0+zG2Y5/zLZ89R6OCbqffpmvQZEQMVWBehFN9hcfQ1ehNMLGPgVHCG+uL6q2jLnqgqlZC0yRfGmDC4gbH3/OjR7EWQxdWyTqFXDilpnYL90uoXV+P2RHhQe2B0guDK5fzkaW69opXb4JRRjVR726/v6+bWMt4v96/NcIJAAedMLgK835k6NH9D6oKiAgTlfX3+/go8sPItg29acbY0f0QDe1e4He4veKrmlcumkXA3yStBCQ== pi@pi3
```

# Comment pousser sa clef signé sur un serveur

Exactement comme pour une clefs public, il faut la mettre dans le fichier autorizekey

```bash
pi@pi3:~/.ssh $ ssh-copy-id -f -i /home/pi/.ssh/clef2-cert.pub pi@pi4b.home
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/pi/.ssh/clef2-cert.pub"
no such identity: /home/pi/.ssh/identity: No such file or directory

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'pi@pi4b.home'"
and check to make sure that only the key(s) you wanted were added.

pi@pi3:~/.ssh $ 
```

```bash
pi@pi3:~/.ssh $ ssh -i clef2  pi@pi4b.home
no such identity: /home/pi/.ssh/identity: No such file or directory
Linux pi4b 4.19.75-v7l+ #1270 SMP Tue Sep 24 18:51:41 BST 2019 armv7l

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sat Mar  7 11:57:23 2020 from 192.168.1.29
pi@pi4b:~ $
```

